---
import { getCollection } from "astro:content";

interface Props {
    variant?: "standard" | "hero";
    showIcon?: boolean;
    hideActions?: boolean;
}

const {
    variant = "standard",
    showIcon = false,
    hideActions = false,
} = Astro.props;

// Process Journal Club (Find next meeting)
const allJournalClub = await getCollection("journal-club");
const now = new Date();

// Helper to convert local date/time to UTC
function convertLocalToUtc(item: (typeof allJournalClub)[0]): string | null {
    const data = item.data;

    // Prefer existing UTC field for backward compatibility
    if (data.startDateTimeUtc && data.startDateTimeUtc.trim()) {
        return data.startDateTimeUtc.trim();
    }

    // Convert from local date/time if available
    if (data.localDate && data.localTime && data.localTime.trim()) {
        const tz = data.eventTz || "Asia/Tokyo";
        const dateStr = data.localDate.toISOString().split("T")[0]; // YYYY-MM-DD
        const timeStr = data.localTime.trim(); // HH:mm

        try {
            // Technique: Create a "fake" local date, then adjust for timezone offset
            const fakeLocalDate = new Date(`${dateStr}T${timeStr}:00`);

            // Get what this date looks like in the target timezone
            const tzDateString = fakeLocalDate.toLocaleString("en-US", {
                timeZone: tz,
            });
            const tzDate = new Date(tzDateString);

            // Calculate the difference
            const diff = fakeLocalDate.getTime() - tzDate.getTime();

            // Apply the difference to get the correct UTC time
            const correctUTC = new Date(fakeLocalDate.getTime() + diff);
            return correctUTC.toISOString();
        } catch (e) {
            console.error("Failed to convert local time to UTC:", e);
        }
    }

    return null;
}

// Helper to get event start and end times
function getEventTimes(item: (typeof allJournalClub)[0]) {
    const data = item.data;

    // Try to get UTC time from either field
    const utcString = convertLocalToUtc(item);
    if (utcString) {
        const start = new Date(utcString);
        const end = new Date(start.getTime() + 2 * 60 * 60 * 1000); // +2 hours
        return { start, end, hasTime: true };
    }

    // Fallback to date only (set to start of day in UTC)
    const start = new Date(data.date);
    start.setUTCHours(0, 0, 0, 0);
    const end = new Date(start);
    end.setUTCHours(23, 59, 59, 999);
    return { start, end, hasTime: false };
}

// Classify events into Upcoming, Live, and Archived
const classifiedEvents = allJournalClub.map((item) => {
    const { start, end, hasTime } = getEventTimes(item);

    let status: "upcoming" | "live" | "archived";
    if (now < start) {
        status = "upcoming";
    } else if (now >= start && now < end) {
        status = "live";
    } else {
        status = "archived";
    }

    return { item, start, end, hasTime, status };
});

// Find the next meeting: prioritize Live, then Upcoming
const liveEvent = classifiedEvents
    .filter((e) => e.status === "live")
    .sort((a, b) => a.start.valueOf() - b.start.valueOf())[0];

const nextUpcoming = classifiedEvents
    .filter((e) => e.status === "upcoming")
    .sort((a, b) => a.start.valueOf() - b.start.valueOf())[0];

const upcomingJournalClub = liveEvent?.item || nextUpcoming?.item || null;
const isLiveNow = !!liveEvent;

// Helper to get speaker display (two-line format)
function getSpeakerInfo(data: typeof upcomingJournalClub.data) {
    // New structured fields
    if (data.speakerName) {
        return {
            name: data.speakerName,
            affiliation: data.speakerAffiliation || null,
        };
    }
    // Fallback to legacy field - try to parse "Name (Affiliation)"
    if (data.speaker) {
        const match = data.speaker.match(/^(.+?)\s*\(([^)]+)\)\s*$/);
        if (match) {
            return { name: match[1].trim(), affiliation: match[2].trim() };
        }
        return { name: data.speaker, affiliation: null };
    }
    return null;
}

// Helper to get primary link
function getPrimaryLink(data: typeof upcomingJournalClub.data) {
    if (data.links && data.links.length > 0) {
        const primary = data.links.find((l) => l.isPrimary) || data.links[0];
        return { label: primary.label, url: primary.url };
    }
    // Fallback to legacy field
    if (data.paperUrl) {
        return { label: "Paper", url: data.paperUrl };
    }
    return null;
}

// Get event detail URL
const eventDetailUrl = upcomingJournalClub
    ? `/journal-club/${upcomingJournalClub.slug}`
    : null;

// Use calendarUrl from event data if available
const calendarUrl = upcomingJournalClub?.data.calendarUrl || null;

// Get speaker info and primary link for the upcoming event
const speakerInfo = upcomingJournalClub
    ? getSpeakerInfo(upcomingJournalClub.data)
    : null;
const primaryLink = upcomingJournalClub
    ? getPrimaryLink(upcomingJournalClub.data)
    : null;
---

<section class={`journal-section variant-${variant}`}>
    <div class="container journal-grid">
        <div class="journal-info">
            {/* Variant: Hero Styles */}
            {
                variant === "hero" ? (
                    <>
                        <div class="journal-header-lockup">
                            {showIcon && (
                                <div class="journal-icon">
                                    <img
                                        src="/images/journal_club/journal_club.png"
                                        alt="Journal Club Icon"
                                        class="journal-icon-img"
                                        loading="eager"
                                    />
                                </div>
                            )}
                            <div>
                                <h2>Stay connected with the RdRp community</h2>
                                <p class="subtitle hero-subtitle">
                                    Join our RNA Virus Journal Club
                                </p>
                            </div>
                        </div>
                    </>
                ) : (
                    <>
                        <div class="journal-header-lockup">
                            {showIcon && (
                                <div class="journal-icon">
                                    <img
                                        src="/images/journal_club/journal_club.png"
                                        alt="Journal Club Icon"
                                        class="journal-icon-img"
                                        loading="lazy"
                                    />
                                </div>
                            )}
                            <div>
                                <h2>Journal Club</h2>
                                <p class="subtitle">
                                    Join our discussion on the latest RdRp
                                    research.
                                </p>
                            </div>
                        </div>
                    </>
                )
            }

            {
                !hideActions && (
                    <div class="actions">
                        <a href="/journal-club" class="link-arrow">
                            View Schedule &rarr;
                        </a>

                        {/* Additional CTA for Hero */}
                        {variant === "hero" && (
                            <a
                                href="https://docs.google.com/forms/d/e/1FAIpQLSdjvzJGh4vtCcq76qP79CW2qniycLix_LMwIfVRdG2bbuuPNg/viewform?usp=dialog"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="link-arrow secondary-link"
                            >
                                Nominate Speaker &rarr;
                            </a>
                        )}
                    </div>
                )
            }
        </div>

        <div class="next-meeting-card">
            {
                upcomingJournalClub ? (
                    <>
                        <span class={`badge ${isLiveNow ? "badge-live" : ""}`}>
                            {isLiveNow ? "Live Now" : "Next Meeting"}
                        </span>
                        <h3 class="paper-title">
                            {upcomingJournalClub.data.title}
                        </h3>
                        <div class="meeting-meta">
                            {speakerInfo && (
                                <div class="speaker-info">
                                    <span class="speaker-name">
                                        {speakerInfo.name}
                                    </span>
                                    {speakerInfo.affiliation && (
                                        <span class="speaker-affiliation">
                                            {speakerInfo.affiliation}
                                        </span>
                                    )}
                                </div>
                            )}
                            <p class="meeting-date">
                                {new Date(
                                    upcomingJournalClub.data.date,
                                ).toLocaleDateString("en-US", {
                                    weekday: "long",
                                    month: "long",
                                    day: "numeric",
                                })}
                            </p>
                        </div>
                        <div class="card-actions">
                            {calendarUrl && (
                                <>
                                    <a
                                        href={calendarUrl}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="button small primary-cal"
                                    >
                                        Add to Google Calendar
                                    </a>
                                </>
                            )}
                            <a href={eventDetailUrl} class="link-arrow">
                                View details &rarr;
                            </a>
                        </div>
                        {calendarUrl && (
                            <p class="calendar-hint">
                                Timezones are handled automatically in Google
                                Calendar.
                            </p>
                        )}
                    </>
                ) : (
                    <div class="empty-state">
                        <h3>No upcoming meetings scheduled</h3>
                        <p>Stay tuned for the next Journal Club.</p>
                        <a href="/journal-club" class="link-arrow">
                            Browse past Journal Clubs &rarr;
                        </a>
                    </div>
                )
            }
        </div>
    </div>
</section>

<style>
    /* Global Reused */
    .container {
        max-width: 980px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 24px;
        border-radius: 980px;
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        transition: all 0.2s ease;
        text-decoration: none;
        cursor: pointer;
        line-height: 1;
    }

    .button.small {
        padding: 8px 16px;
        font-size: 14px;
    }
    .button.outline {
        border: 1px solid #ddd;
        color: var(--c-text);
    }
    .button.outline:hover {
        border-color: var(--c-link);
        color: var(--c-link);
    }

    .button.secondary {
        background-color: transparent;
        color: var(--c-link);
        border: 1px solid var(--c-link);
    }
    .button.secondary:hover {
        background-color: rgba(0, 112, 243, 0.05);
    }

    .button.primary-cal {
        background-color: var(--c-primary, #0070f3);
        color: white;
        border: none;
    }
    .button.primary-cal:hover {
        opacity: 0.9;
    }

    /* Journal Club Section */
    .journal-section {
        padding: 60px 0;
        background-color: #fafbfc;
        border-top: 1px solid rgba(0, 0, 0, 0.03);
        border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        margin-bottom: 60px;
    }

    /* Variant: Hero */
    .journal-section.variant-hero {
        background: linear-gradient(
            180deg,
            rgba(240, 248, 255, 0.6) 0%,
            #fafbfc 100%
        );
        padding: 80px 0;
    }
    .journal-section.variant-hero h2 {
        font-size: 2.5rem;
        line-height: 1.2;
        color: #111;
    }
    .hero-subtitle {
        font-size: 1.25rem !important;
        color: #555;
        margin-bottom: 1.5rem;
        font-style: italic;
    }

    .journal-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 60px;
        align-items: center;
    }

    @media (max-width: 768px) {
        .journal-grid {
            grid-template-columns: 1fr;
            gap: 40px;
        }
    }

    .journal-info h2 {
        font-size: 32px;
        margin-bottom: 12px;
    }

    .journal-header-lockup {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        margin-bottom: 24px;
    }

    .journal-icon {
        flex-shrink: 0;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .journal-icon-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .journal-section.variant-hero .journal-icon {
        width: 100px;
        height: 100px;
        /* Removed background/shadow for transparent PNG look, or keep if user wants a box. 
           User asked for "appropriate size", usually implied seamless if PNG. 
           I'll assume clean look without box for now. */
    }

    .subtitle {
        color: var(--c-text-secondary);
        font-size: 18px;
        margin-bottom: 0px; /* Reset, handled by lockup */
        line-height: 1.5;
    }

    .actions {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .next-meeting-card {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .badge {
        display: inline-block;
        background-color: #f3e8ff;
        color: #7928ca;
        padding: 4px 10px;
        border-radius: 99px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 16px;
    }

    .badge-live {
        background-color: #dcfce7;
        color: #166534;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }

    .paper-title {
        font-size: 20px;
        margin-bottom: 16px;
        line-height: 1.4;
    }

    .meeting-meta {
        margin-bottom: 24px;
        font-size: 15px;
        color: #555;
    }

    .meeting-meta p {
        margin: 4px 0;
    }

    .speaker-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-bottom: 8px;
    }

    .speaker-name {
        font-weight: 600;
        color: var(--c-text);
    }

    .speaker-affiliation {
        font-size: 0.9em;
        color: var(--c-text-secondary);
    }

    .meeting-date {
        margin: 0;
        color: var(--c-text-secondary);
    }

    .card-actions {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .calendar-hint {
        font-size: 0.8rem;
        color: var(--c-text-secondary, #666);
        margin-top: 12px;
        margin-bottom: 0;
        font-style: italic;
    }

    .link-arrow {
        font-size: 14px;
        font-weight: 600;
        color: var(--c-link);
        text-decoration: none;
    }
    .link-arrow:hover {
        text-decoration: underline;
    }

    .secondary-link {
        color: #666;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 1rem;
        color: #666;
    }
</style>
