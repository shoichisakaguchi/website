---
import { getCollection, getEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export const prerender = true;

export async function getStaticPaths() {
  const summits = await getCollection("summits");
  return summits.map((item) => ({
    params: { slug: item.slug },
    props: { item },
  }));
}

const { item } = Astro.props;
const { Content } = await item.render();

import type { CollectionEntry } from "astro:content";

type Organizer = CollectionEntry<"people">["data"] & {
  displayRole?: string;
  section?: string;
  country?: string;
};

// Resolve organizers
let organizers: Organizer[] = [];
if (item.data.organizers) {
  const resolvedOrganizers = await Promise.all(
    item.data.organizers.map(async (org: any) => {
      try {
        const personEntry = await getEntry("people", org.person);
        if (!personEntry) return null;

        // Override affiliation if present in summit data
        const affiliation = org.affiliation || personEntry.data.affiliation;

        return {
          ...personEntry.data,
          affiliation,
          displayRole: org.role,
          section: org.section,
        } as Organizer;
      } catch (e) {
        return null;
      }
    }),
  );
  // Filter out nulls
  organizers = resolvedOrganizers.filter(
    (org): org is Organizer => org !== null,
  );
}

// Helper to check if optional sections have content
const hasTravelGrant =
  item.data.travelGrant &&
  (item.data.travelGrant.amount ||
    item.data.travelGrant.currency ||
    item.data.travelGrant.eligibility ||
    item.data.travelGrant.applicationUrl ||
    item.data.travelGrant.notes);

const hasArchiveResources =
  item.data.archiveResources &&
  (item.data.archiveResources.recordingsUrl ||
    item.data.archiveResources.slidesUrl ||
    item.data.archiveResources.photoGalleryUrl ||
    item.data.archiveResources.reportUrl);
---

<Layout title={item.data.title}>
  <div class="container page-content">
    <div class="back-link">
      <a href="/summits">‚Üê Back to Summits</a>
    </div>
    <header class="post-header">
      {
        item.data.heroImage && (
          <div class="hero-image-wrapper">
            <img
              src={item.data.heroImage}
              alt=""
              class="hero-image"
              loading="eager"
            />
          </div>
        )
      }
      {
        item.data.phase && (
          <div class={`phase-badge ${item.data.phase.toLowerCase()}`}>
            {item.data.phase}
          </div>
        )
      }
      <h1 class="page-title">{item.data.title}</h1>
      <div class="meta">
        <span class="year">{item.data.year}</span>
        {
          item.data.city || item.data.country ? (
            <span class="location">
              {[item.data.city, item.data.country].filter(Boolean).join(", ")}
            </span>
          ) : (
            item.data.location && (
              <span class="location">{item.data.location}</span>
            )
          )
        }
        {item.data.format && <span class="format">({item.data.format})</span>}
      </div>
      {
        item.data.satelliteOf && (
          <div class="satellite-info">
            Satellite event of{" "}
            {item.data.satelliteOf.url ? (
              <a
                href={item.data.satelliteOf.url}
                target="_blank"
                rel="noopener noreferrer"
              >
                {item.data.satelliteOf.name}
              </a>
            ) : (
              item.data.satelliteOf.name
            )}
          </div>
        )
      }

      {/* Key Links Buttons */}
      <div class="header-actions">
        {
          item.data.links?.registration && item.data.phase === "Planning" && (
            <a href={item.data.links.registration} class="button secondary">
              Register Now
            </a>
          )
        }
      </div>
    </header>

    <div class="content-wrapper">
      {/* Intro / Context */}
      {
        item.data.intro && (
          <div class="summit-intro">
            <p>{item.data.intro}</p>
          </div>
        )
      }

      {/* Featured Invited Speakers */}
      {
        item.data.speakers && item.data.speakers.length > 0 && (
          <section class="speakers-section">
            <h2>Featured Invited Speakers</h2>
            <div class="speakers-grid">
              {item.data.speakers.map((speaker) => (
                <div class="speaker-card">
                  {/* Headshot */}
                  {speaker.image && (
                    <img
                      src={speaker.image}
                      alt={speaker.name}
                      class="speaker-headshot"
                      loading="lazy"
                    />
                  )}
                  <div class="speaker-info">
                    <h4 class="speaker-name">
                      {speaker.link ? (
                        <a
                          href={speaker.link}
                          target="_blank"
                          rel="noopener noreferrer"
                        >
                          {speaker.name}
                        </a>
                      ) : (
                        speaker.name
                      )}
                    </h4>
                    {speaker.role && <p class="speaker-role">{speaker.role}</p>}
                    {speaker.affiliation && (
                      <p class="speaker-affiliation">{speaker.affiliation}</p>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </section>
        )
      }

      {/* Program / Archive Block */}
      {
        (item.data.links?.detailedProgram || hasArchiveResources) && (
          <section class="program-archive-section">
            <div class="program-archive-container">
              {item.data.links?.detailedProgram && (
                <div class="program-block">
                  <h3>Detailed Program</h3>
                  <a
                    href={item.data.links.detailedProgram}
                    class="button primary"
                  >
                    View Detailed Program
                  </a>
                </div>
              )}

              {hasArchiveResources && (
                <div class="archive-block">
                  <h3>Archive Resources</h3>
                  <div class="archive-links">
                    {item.data.archiveResources?.reportUrl && (
                      <a
                        href={item.data.archiveResources.reportUrl}
                        class="archive-link"
                      >
                        üìÑ Post-Summit Report
                      </a>
                    )}
                    {item.data.archiveResources?.recordingsUrl && (
                      <a
                        href={item.data.archiveResources.recordingsUrl}
                        class="archive-link"
                      >
                        ‚ñ∂Ô∏è Recordings
                      </a>
                    )}
                    {item.data.archiveResources?.slidesUrl && (
                      <a
                        href={item.data.archiveResources.slidesUrl}
                        class="archive-link"
                      >
                        üìä Slides
                      </a>
                    )}
                    {item.data.archiveResources?.photoGalleryUrl && (
                      <a
                        href={item.data.archiveResources.photoGalleryUrl}
                        class="archive-link"
                      >
                        üì∏ Photo Gallery
                      </a>
                    )}
                  </div>
                </div>
              )}
            </div>
          </section>
        )
      }

      <article>
        <Content />
      </article>

      {/* Community Outcomes */}
      {
        item.data.communityOutcomes &&
          item.data.communityOutcomes.length > 0 && (
            <section class="outcomes-section">
              <h2>Community Outcomes</h2>
              <div class="outcomes-list">
                {item.data.communityOutcomes.map((outcome) => (
                  <div class="outcome-item">
                    <span class="outcome-type">{outcome.type}</span>
                    <div class="outcome-details">
                      <h3 class="outcome-title">
                        {outcome.url ? (
                          <a
                            href={outcome.url}
                            target="_blank"
                            rel="noopener noreferrer"
                          >
                            {outcome.title}
                          </a>
                        ) : (
                          outcome.title
                        )}
                      </h3>
                      {outcome.description && (
                        <p class="outcome-desc">{outcome.description}</p>
                      )}
                      <div class="outcome-meta">
                        {outcome.doi && (
                          <span class="doi">DOI: {outcome.doi}</span>
                        )}
                        {outcome.date && (
                          <span class="date">
                            {new Date(outcome.date).toLocaleDateString()}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )
      }

      {/* Sponsors */}
      {
        item.data.sponsors && item.data.sponsors.length > 0 && (
          <section class="sponsors-section">
            <h2>Sponsors</h2>
            <div class="sponsors-grid">
              {item.data.sponsors.map((sponsor) => (
                <a
                  href={sponsor.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="sponsor-card"
                >
                  {sponsor.logo ? (
                    <img
                      src={sponsor.logo}
                      alt={sponsor.name}
                      class="sponsor-logo"
                    />
                  ) : (
                    <span class="sponsor-name">{sponsor.name}</span>
                  )}
                  {sponsor.supportType && (
                    <span class="support-type">{sponsor.supportType}</span>
                  )}
                </a>
              ))}
            </div>
          </section>
        )
      }

      {/* Travel Grants */}
      {
        hasTravelGrant && (
          <section class="grants-section">
            <h2>Travel Grants</h2>
            <div class="grant-card">
              {item.data.travelGrant?.amount &&
                item.data.travelGrant?.currency && (
                  <p>
                    <strong>Amount:</strong> {item.data.travelGrant.amount}{" "}
                    {item.data.travelGrant.currency}
                  </p>
                )}
              {item.data.travelGrant?.eligibility && (
                <p>
                  <strong>Eligibility:</strong>{" "}
                  {item.data.travelGrant.eligibility}
                </p>
              )}
              {item.data.travelGrant?.notes && (
                <p class="grant-notes">{item.data.travelGrant.notes}</p>
              )}
              {item.data.travelGrant?.applicationUrl && (
                <a
                  href={item.data.travelGrant.applicationUrl}
                  class="button small"
                >
                  Apply for Grant
                </a>
              )}
            </div>
          </section>
        )
      }

      {
        organizers.length > 0 && (
          <section class="organizers-section">
            <h2>The Organizing Team</h2>
            <div class="organizers-grid">
              {organizers.map((org) => (
                <div class="organizer-card">
                  {org.image && (
                    <img
                      src={org.image.src}
                      alt={org.name}
                      class="organizer-image"
                      loading="lazy"
                    />
                  )}
                  <h3 class="organizer-name">{org.name}</h3>
                  {org.displayRole && (
                    <p class="organizer-role">{org.displayRole}</p>
                  )}
                  {org.affiliation && (
                    <p class="organizer-affiliation">{org.affiliation}</p>
                  )}
                  {org.country && (
                    <p class="organizer-country">{org.country}</p>
                  )}
                </div>
              ))}
            </div>
          </section>
        )
      }

      {/* Footer Links (CoC) */}
      {
        item.data.links?.codeOfConduct && (
          <div class="footer-links">
            {item.data.links.codeOfConduct && (
              <a
                href={item.data.links.codeOfConduct}
                target="_blank"
                rel="noopener noreferrer"
              >
                Code of Conduct
              </a>
            )}
          </div>
        )
      }
    </div>
  </div>
</Layout>

<style>
  .page-content {
    max-width: 800px;
    margin: 0 auto;
    padding-bottom: 4rem;
  }

  .page-title {
    margin-top: 20px;
    margin-bottom: 10px;
    text-align: center;
    font-size: 2.5rem;
  }

  .post-header {
    margin-top: 40px;
    margin-bottom: 60px;
    text-align: center;
  }

  .hero-image-wrapper {
    margin-bottom: 30px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  }

  .hero-image {
    width: 100%;
    height: auto;
    max-height: 450px;
    object-fit: cover;
    display: block;
  }

  .meta {
    color: var(--c-text-light, #666);
    font-size: 1.2rem;
    display: flex;
    justify-content: center;
    gap: 20px;
  }

  .year,
  .location {
    font-weight: 500;
  }

  .content-wrapper {
    font-size: 18px;
    line-height: 1.7;
    color: var(--c-text, #333);
  }

  .back-link {
    margin-top: 40px;
  }

  .back-link a {
    color: var(--c-text-light, #666);
    text-decoration: none;
    font-size: 0.9em;
  }

  .back-link a:hover {
    text-decoration: underline;
  }

  /* Content Styling */
  article :global(h2) {
    margin-top: 2em;
    font-size: 1.8em;
    font-weight: 700;
  }

  article :global(h3) {
    margin-top: 1.5em;
    font-size: 1.4em;
    font-weight: 600;
  }

  article :global(p) {
    margin-bottom: 1.2em;
  }

  /* Speakers Section */
  .speakers-section {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #eee;
  }

  .speakers-section h2 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2rem;
    color: var(--c-text);
  }

  .speakers-grid {
    display: grid;
    grid-template-columns: 1fr; /* Mobile: 1 col */
    gap: 2rem;
  }

  @media (min-width: 640px) {
    .speakers-grid {
      grid-template-columns: repeat(2, 1fr); /* Tablet: 2 cols */
    }
  }

  @media (min-width: 1024px) {
    .speakers-grid {
      grid-template-columns: repeat(3, 1fr); /* Desktop: 3 cols */
    }
  }

  .speaker-card {
    background: #f9f9f9;
    padding: 1.5rem;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: transform 0.2s;
  }
  .speaker-card:hover {
    transform: translateY(-3px);
  }

  .speaker-headshot {
    width: 96px;
    height: 96px;
    border-radius: 0.5rem; /* Rounding only */
    object-fit: cover;
    aspect-ratio: 1/1;
    margin-bottom: 1rem;
    background-color: #ddd;
  }

  @media (min-width: 640px) {
    .speaker-headshot {
      width: 110px;
      height: 110px;
    }
  }

  @media (min-width: 1024px) {
    .speaker-headshot {
      width: 130px;
      height: 130px;
    }
  }

  /* Intro Section */
  .summit-intro {
    max-width: 700px;
    margin: 0 auto 3rem auto;
    font-size: 1.25rem;
    line-height: 1.6;
    color: var(--c-text, #333);
    text-align: left; /* Or center? User didn't specify, standard text usually left or center. Intro/Teaser often centered if short. */
  }

  /* Program & Archive Section */
  .program-archive-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 3rem;
    text-align: center;
  }

  .program-archive-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    align-items: center;
  }

  .program-block h3,
  .archive-block h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.4rem;
  }

  /* Re-use Archive Link Styles */
  .archive-links {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    margin-top: 0.5rem;
  }
  .archive-link {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    text-decoration: none;
    color: #333;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s;
  }
  .archive-link:hover {
    border-color: var(--c-primary, #0066cc);
    color: var(--c-primary, #0066cc);
  }

  .speaker-name {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: var(--c-text);
  }

  .speaker-name a {
    text-decoration: none;
    color: inherit;
  }

  .speaker-name a:hover {
    text-decoration: underline;
    color: var(--c-primary, #0066cc);
  }

  .speaker-role {
    font-size: 1rem;
    font-weight: 500;
    color: var(--c-primary, #0066cc);
    margin-bottom: 0.25rem;
    line-height: 1.3;
  }

  .speaker-affiliation {
    display: block;
    font-size: 0.9rem;
    color: #666;
    margin-top: 0;
    font-style: italic;
  }

  /* Organizers Section */
  .organizers-section {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }

  .organizers-section h2 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2rem;
  }

  .organizers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 2rem;
    text-align: center;
  }

  .organizer-card {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .organizer-image {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 1rem;
    background-color: #f0f0f0;
  }

  .organizer-name {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0 0 0.25rem 0;
  }

  .organizer-role {
    font-size: 0.9rem;
    color: var(--c-primary, #0066cc);
    font-weight: 600;
    margin: 0 0 0.25rem 0;
  }

  .organizer-affiliation {
    font-size: 0.85rem;
    color: #666;
    margin: 0;
    line-height: 1.4;
  }

  .organizer-country {
    font-size: 0.85rem;
    color: #888;
    margin-top: 0.1rem;
  }

  /* Header actions & Badges */
  .phase-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 1rem;
    text-transform: uppercase;
  }
  .phase-badge.planning {
    background: #e0f2fe;
    color: #0369a1;
  }
  .phase-badge.live {
    background: #dcfce7;
    color: #15803d;
  }
  .phase-badge.archived {
    background: #f3f4f6;
    color: #374151;
  }

  .header-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
  }
  .button {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
  }
  .button.primary {
    background: var(--c-primary, #0066cc);
    color: white;
  }
  .button.primary:hover {
    opacity: 0.9;
  }
  .button.secondary {
    background: white;
    border: 2px solid var(--c-primary, #0066cc);
    color: var(--c-primary, #0066cc);
  }
  .button.secondary:hover {
    background: #f0f9ff;
  }

  /* Outcomes */
  .outcomes-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }
  .outcomes-section h2 {
    text-align: center;
    margin-bottom: 1.5rem;
    font-size: 2rem;
  }
  .outcomes-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .outcome-item {
    border-left: 4px solid var(--c-primary, #0066cc);
    padding-left: 1rem;
  }
  .outcome-type {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #666;
    font-weight: 700;
    letter-spacing: 0.05em;
  }
  .outcome-title {
    font-size: 1.2rem;
    margin: 0.25rem 0;
    font-weight: 600;
  }
  .outcome-title a {
    text-decoration: none;
    color: inherit;
  }
  .outcome-title a:hover {
    color: var(--c-primary, #0066cc);
    text-decoration: underline;
  }
  .outcome-desc {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 0.5rem;
  }
  .outcome-meta {
    font-size: 0.85rem;
    color: #888;
    display: flex;
    gap: 1rem;
  }

  /* Sponsors */
  .sponsors-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }
  .sponsors-section h2 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2rem;
  }
  .sponsors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 2rem;
    align-items: center;
    justify-content: center;
  }
  .sponsor-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #333;
    padding: 1rem;
    transition: transform 0.2s;
  }
  .sponsor-card:hover {
    transform: translateY(-3px);
  }
  .sponsor-logo {
    max-width: 100%;
    max-height: 80px;
    object-fit: contain;
    filter: grayscale(100%);
    transition: filter 0.3s;
  }
  .sponsor-card:hover .sponsor-logo {
    filter: grayscale(0%);
  }

  /* Travel Grants */
  .grants-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }
  .grants-section h2 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2rem;
  }
  .grant-card {
    background: #f9f9f9;
    border: 1px solid #eee;
    padding: 2rem;
    border-radius: 12px;
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
  }
  .grant-card p {
    margin-bottom: 1rem;
  }
  .grant-notes {
    font-style: italic;
    color: #666;
  }

  .footer-links {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
    text-align: center;
  }
  .footer-links a {
    color: #666;
    text-decoration: none;
    font-size: 0.9rem;
  }
  .footer-links a:hover {
    text-decoration: underline;
    color: var(--c-primary, #0066cc);
  }
</style>
