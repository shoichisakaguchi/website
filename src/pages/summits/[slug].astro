---
import { getCollection, getEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export const prerender = true;

export async function getStaticPaths() {
  const summits = await getCollection("summits");
  return summits.map((item) => ({
    params: { slug: item.slug },
    props: { item },
  }));
}

const { item } = Astro.props;
const { Content } = await item.render();

import type { CollectionEntry } from "astro:content";

type Organizer = CollectionEntry<"people">["data"] & {
  displayRole?: string;
  section?: string;
  country?: string;
};

// Resolve organizers
let organizers: Organizer[] = [];
if (item.data.organizers) {
  const resolvedOrganizers = await Promise.all(
    item.data.organizers.map(async (org: any) => {
      try {
        const personEntry = await getEntry("people", org.person);
        if (!personEntry) return null;

        // Override affiliation if present in summit data
        const affiliation = org.affiliation || personEntry.data.affiliation;

        return {
          ...personEntry.data,
          affiliation,
          displayRole: org.role,
          section: org.section,
        } as Organizer;
      } catch (e) {
        return null;
      }
    }),
  );
  // Filter out nulls
  organizers = resolvedOrganizers.filter(
    (org): org is Organizer => org !== null,
  );
}
---

<Layout title={item.data.title}>
  <div class="container page-content">
    <div class="back-link">
      <a href="/summits">← Back to Summits</a>
    </div>
    <header class="post-header">
      <h1 class="page-title">{item.data.title}</h1>
      <div class="meta">
        <span class="year">{item.data.year}</span>
        {
          item.data.location && (
            <span class="location">{item.data.location}</span>
          )
        }
      </div>
    </header>

    <div class="content-wrapper">
      <article>
        <Content />
      </article>

      {
        item.data.speakers && item.data.speakers.length > 0 && (
          <section class="speakers-section">
            <h2>Featured Invited Speakers</h2>
            <div class="speakers-list">
              {item.data.speakers.map((session) => (
                <div class="session-block">
                  <h3 class="session-title">{session.name}</h3>
                  <div class="talks-grid">
                    {session.talks.map((talk) => (
                      <div class="talk-card">
                        <div class="talk-header">
                          <h4 class="speaker-name">
                            {talk.url ? (
                              <a
                                href={talk.url}
                                target="_blank"
                                rel="noopener noreferrer"
                              >
                                {talk.name}
                              </a>
                            ) : (
                              talk.name
                            )}
                          </h4>
                          {talk.affiliation && (
                            <span class="speaker-affiliation">
                              {talk.affiliation}
                            </span>
                          )}
                        </div>
                        <p class="talk-title">“{talk.title}”</p>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </section>
        )
      }

      {
        organizers.length > 0 && (
          <section class="organizers-section">
            <h2>The Organizing Team</h2>
            <div class="organizers-grid">
              {organizers.map((org) => (
                <div class="organizer-card">
                  {org.image && (
                    <img
                      src={org.image.src}
                      alt={org.name}
                      class="organizer-image"
                      loading="lazy"
                    />
                  )}
                  <h3 class="organizer-name">{org.name}</h3>
                  {org.displayRole && (
                    <p class="organizer-role">{org.displayRole}</p>
                  )}
                  {org.affiliation && (
                    <p class="organizer-affiliation">{org.affiliation}</p>
                  )}
                  {org.country && (
                    <p class="organizer-country">{org.country}</p>
                  )}
                </div>
              ))}
            </div>
          </section>
        )
      }
    </div>
  </div>
</Layout>

<style>
  .page-content {
    max-width: 800px;
    margin: 0 auto;
    padding-bottom: 4rem;
  }

  .page-title {
    margin-top: 20px;
    margin-bottom: 10px;
    text-align: center;
    font-size: 2.5rem;
  }

  .post-header {
    margin-top: 40px;
    margin-bottom: 60px;
    text-align: center;
  }

  .meta {
    color: var(--c-text-light, #666);
    font-size: 1.2rem;
    display: flex;
    justify-content: center;
    gap: 20px;
  }

  .year,
  .location {
    font-weight: 500;
  }

  .content-wrapper {
    font-size: 18px;
    line-height: 1.7;
    color: var(--c-text, #333);
  }

  .back-link {
    margin-top: 40px;
  }

  .back-link a {
    color: var(--c-text-light, #666);
    text-decoration: none;
    font-size: 0.9em;
  }

  .back-link a:hover {
    text-decoration: underline;
  }

  /* Content Styling */
  article :global(h2) {
    margin-top: 2em;
    font-size: 1.8em;
    font-weight: 700;
  }

  article :global(h3) {
    margin-top: 1.5em;
    font-size: 1.4em;
    font-weight: 600;
  }

  article :global(p) {
    margin-bottom: 1.2em;
  }

  /* Speakers Section */
  .speakers-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }

  .speakers-section h2 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2rem;
    color: var(--c-text);
  }

  .session-block {
    margin-bottom: 2.5rem;
  }

  .session-title {
    text-align: center;
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--c-primary, #0066cc);
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0.5rem;
    display: inline-block;
    width: 100%;
  }

  .talks-grid {
    display: grid;
    gap: 1.5rem;
  }

  .talk-card {
    background: #f9f9f9;
    padding: 1.2rem;
    border-radius: 8px;
    border-left: 4px solid var(--c-primary, #0066cc);
  }

  .talk-header {
    margin-bottom: 0.5rem;
  }

  .speaker-name {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    color: var(--c-text);
  }

  .speaker-name a {
    text-decoration: none;
    color: inherit;
  }

  .speaker-name a:hover {
    text-decoration: underline;
    color: var(--c-primary, #0066cc);
  }

  .speaker-affiliation {
    display: block;
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.2rem;
    font-style: italic;
  }

  .talk-title {
    font-size: 1rem;
    margin: 0;
    font-weight: 500;
    color: #333;
    line-height: 1.5;
  }

  /* Organizers Section */
  .organizers-section {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }

  .organizers-section h2 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2rem;
  }

  .organizers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 2rem;
    text-align: center;
  }

  .organizer-card {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .organizer-image {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 1rem;
    background-color: #f0f0f0;
  }

  .organizer-name {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0 0 0.25rem 0;
  }

  .organizer-role {
    font-size: 0.9rem;
    color: var(--c-primary, #0066cc);
    font-weight: 600;
    margin: 0 0 0.25rem 0;
  }

  .organizer-affiliation {
    font-size: 0.85rem;
    color: #666;
    margin: 0;
    line-height: 1.4;
  }

  .organizer-country {
    font-size: 0.85rem;
    color: #888;
    margin-top: 0.1rem;
  }
</style>
