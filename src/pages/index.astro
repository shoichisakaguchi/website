---
import Layout from "../layouts/Layout.astro";
import HomeAnnouncements from "../components/HomeAnnouncements.astro";
import JournalClubHome from "../components/JournalClubHome.astro";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import SummitDetail from "../components/SummitDetail.astro";
import { formatDate } from "../utils/date";

export const prerender = true;

// 1. Determine "Active Summit" (Single Source of Truth)
const allSummits = await getCollection("summits");

// Sort summits by year (descending) for the simple list
const sortedSummits = [...allSummits].sort((a, b) => {
	const yearA = parseInt(a.data.year || "0");
	const yearB = parseInt(b.data.year || "0");
	return yearB - yearA;
});
const summitInfo = await getEntry("summit", "info");

let activeSummit: CollectionEntry<"summits"> | undefined;

// Strategy 0: Explicit "Featured Summit" from Keystatic
if (summitInfo?.data?.featuredSummit) {
	activeSummit = allSummits.find(
		(s) => s.slug === summitInfo.data.featuredSummit,
	);
}

// Strategy 1: Look for "Live"
if (!activeSummit) {
	activeSummit = allSummits.find((s) => s.data.phase === "Live");
}

// Strategy 2: Look for "Preview"
if (!activeSummit) {
	activeSummit = allSummits.find((s) => s.data.phase === "Preview");
}

// Strategy 3: Look for "Planning"
if (!activeSummit) {
	activeSummit = allSummits.find((s) => s.data.phase === "Planning");
}

// Strategy 4: Fallback to latest by date/year
if (!activeSummit && allSummits.length > 0) {
	activeSummit = allSummits.sort((a, b) => {
		const dateA = a.data.startDate
			? new Date(a.data.startDate).valueOf()
			: 0;
		const dateB = b.data.startDate
			? new Date(b.data.startDate).valueOf()
			: 0;
		if (dateA !== dateB) return dateB - dateA;
		// Fallback to year string comparison
		return (b.data.year || "").localeCompare(a.data.year || "");
	})[0];
}

// Apply Phase Override if present AND not "Auto"
if (
	activeSummit &&
	summitInfo.data.overridePhase &&
	summitInfo.data.overridePhase !== 'Auto'
) {
	activeSummit = {
		...activeSummit,
		data: {
			...activeSummit.data,
			phase: summitInfo.data.overridePhase,
		},
	};
}

const currentPhase = activeSummit?.data.phase || "Planning";
---

<Layout>
	<div data-pagefind-body>
		{/* About RdRp Summit Section - Shown at top for all phases */}
		<section class="about-summary">
			<div class="container">
				<h2>About RdRp Summit</h2>
				<p>
					The RdRp Summit is a global research community focused on RNA-dependent RNA polymerase (RdRp),
					a key enzyme shared by all RNA viruses. We bring together researchers to advance the discovery,
					classification, and analysis of RNA viruses through open discussion, shared data, and community-driven standards.
				</p>
				<a href="/about" class="link-arrow">Read more &rarr;</a>
			</div>
		</section>

		{
			/*
            PHASE: PLANNING
            Goal: Enable contact with organizers.
            Content: About summary (above), Journal Club (hero - to drive participation), Past Summits list.
        */
		}
		{
			currentPhase === "Planning" && (
				<>
					<JournalClubHome variant="hero" showIcon={true} hideActions={true} />
				</>
			)
		}

		{
			/*
            PHASE: PREVIEW
            Goal: Announce upcoming event (save the date).
            Content: "Save the date", Basic facts, Passive CTA.
        */
		}
		{
			currentPhase === "Preview" && !!activeSummit && (
				<>
					<section class="hero-preview">
						<div class="container hero-content">
							<span class="eyebrow">Upcoming Event</span>
							<h1>{activeSummit.data.title}</h1>
							<div class="event-meta">
								{activeSummit.data.startDate && (
									<p class="date">
										Save the Date:{" "}
										{formatDate(new Date(activeSummit.data.startDate))}
									</p>
								)}
								{(activeSummit.data.city ||
									activeSummit.data.country) && (
									<p class="location">
										{[
											activeSummit.data.city,
											activeSummit.data.country,
										]
											.filter(Boolean)
											.join(", ")}
									</p>
								)}
							</div>
							{/* Passive CTA if a detail page exists/is desired, or just omit */}
							<div class="cta-wrapper">
								<span class="info-text">
									More details coming soon.
								</span>
							</div>
						</div>
					</section>
					<JournalClubHome variant="hero" showIcon={true} hideActions={true} />
				</>
			)
		}

		{
			/*
            PHASE: LIVE
            Goal: Drive registration / participation.
            Content: SummitDetail (Full) + Journal Club (hero).
        */
		}
		{
			currentPhase === "Live" && !!activeSummit && (
				<>
					<SummitDetail item={activeSummit} variant="home" />
					<JournalClubHome variant="hero" showIcon={true} hideActions={true} />
				</>
			)
		}

		{
			/*
            PHASE: ARCHIVED
            Goal: Access to past outcomes.
            Content: Journal Club (Hero) + Past Summits (simple list).
        */
		}
		{
			currentPhase === "Archived" && !!activeSummit && (
				<>
					<JournalClubHome variant="hero" showIcon={true} hideActions={true} />
				</>
			)
		}

		{/* COMMON SECTIONS */}
		<HomeAnnouncements />

		{/* Past RdRp Summits - Simple list for all phases */}
		<section class="past-summits-list">
			<div class="container">
				<h2>Past RdRp Summits</h2>
				<div class="summits-grid">
					{sortedSummits.map((summit) => (
						<a href={`/summits/${summit.slug}`} class="summit-item">
							<span class="summit-year">{summit.data.year}</span>
							<span class="summit-title">{summit.data.title}</span>
							{(summit.data.city || summit.data.country) && (
								<span class="summit-location">
									{[summit.data.city, summit.data.country]
										.filter(Boolean)
										.join(", ")}
								</span>
							)}
							<span class={`summit-phase ${summit.data.phase?.toLowerCase()}`}>
								{summit.data.phase}
							</span>
						</a>
					))}
				</div>
				<a href="/summits" class="link-arrow browse-all">
					Browse all summits &rarr;
				</a>
			</div>
		</section>

	</div>
</Layout>

<style>
	/* Global Reused */
	.container {
		max-width: 980px;
		margin: 0 auto;
		padding: 0 20px;
	}

	/* Hero Styles for Planning & Preview */
	.hero-planning,
	.hero-preview {
		padding: 100px 0;
		text-align: center;
		background: linear-gradient(
			180deg,
			rgba(230, 246, 255, 0.5) 0%,
			white 100%
		);
	}

	.hero-content h1 {
		font-size: 2.5rem;
		font-weight: 800;
		margin-bottom: 20px;
		color: var(--c-text);
	}

	.subtitle {
		font-size: 1.25rem;
		color: var(--c-text-secondary);
		margin-bottom: 40px;
		max-width: 600px;
		margin-left: auto;
		margin-right: auto;
	}

	.cta-wrapper {
		margin-top: 30px;
	}

	.button.primary {
		background-color: var(--c-primary);
		color: white;
		padding: 12px 24px;
		border-radius: 8px;
		text-decoration: none;
		font-weight: 600;
		transition: opacity 0.2s;
	}
	.button.primary:hover {
		opacity: 0.9;
	}

	/* Preview Specific */
	.eyebrow {
		text-transform: uppercase;
		font-size: 0.9rem;
		letter-spacing: 0.1em;
		color: var(--c-primary);
		font-weight: 700;
		margin-bottom: 10px;
		display: block;
	}
	.event-meta {
		font-size: 1.2rem;
		margin-bottom: 30px;
		color: var(--c-text);
	}
	.info-text {
		color: var(--c-text-secondary);
		font-style: italic;
	}

	/* Past Summits Section Wrapper (Archived) */
	.past-summits-section {
		padding-top: 40px;
	}
	.past-summits-section .section-header {
		text-align: center;
		margin-bottom: 20px;
	}
	.past-summits-section h2 {
		font-size: 2rem;
		margin-bottom: 10px;
	}
	.past-summits-section p {
		color: var(--c-text-secondary);
		font-size: 1.1rem;
	}

	/* About Summary Section */
	.about-summary {
		text-align: center;
		padding: 60px 0 40px;
		background: linear-gradient(
			180deg,
			rgba(230, 246, 255, 0.5) 0%,
			white 100%
		);
	}
	.about-summary h2 {
		font-size: 2rem;
		margin-bottom: 1rem;
		font-weight: 700;
	}
	.about-summary p {
		color: var(--c-text-secondary);
		font-size: 1.1rem;
		line-height: 1.7;
		max-width: 700px;
		margin: 0 auto 1.5rem;
	}

	/* Past Summits List Section */
	.past-summits-list {
		text-align: center;
		padding: 60px 0;
		background-color: #f9fafb;
		border-top: 1px solid rgba(0, 0, 0, 0.05);
		border-bottom: 1px solid rgba(0, 0, 0, 0.05);
	}
	.past-summits-list h2 {
		font-size: 1.8rem;
		margin-bottom: 1.5rem;
	}
	.summits-grid {
		display: flex;
		flex-direction: column;
		gap: 12px;
		max-width: 600px;
		margin: 0 auto 1.5rem;
	}
	.summit-item {
		display: grid;
		grid-template-columns: auto 1fr auto auto;
		align-items: center;
		gap: 16px;
		padding: 16px 20px;
		background: white;
		border-radius: 12px;
		text-decoration: none;
		color: inherit;
		border: 1px solid rgba(0, 0, 0, 0.05);
		transition: transform 0.2s, box-shadow 0.2s;
	}
	.summit-item:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
	}
	.summit-year {
		font-weight: 700;
		font-size: 1.1rem;
		color: var(--c-primary);
	}
	.summit-title {
		font-weight: 600;
		text-align: left;
	}
	.summit-location {
		font-size: 0.9rem;
		color: var(--c-text-secondary);
	}
	.summit-phase {
		font-size: 0.75rem;
		text-transform: uppercase;
		font-weight: 600;
		padding: 4px 8px;
		border-radius: 4px;
		background: #f3f4f6;
		color: #374151;
	}
	.summit-phase.archived {
		background: #f3f4f6;
		color: #374151;
	}
	.summit-phase.planning {
		background: #e0f2fe;
		color: #0369a1;
	}
	.summit-phase.live {
		background: #dcfce7;
		color: #15803d;
	}
	.browse-all {
		display: inline-block;
		margin-top: 0.5rem;
	}

	@media (max-width: 640px) {
		.summit-item {
			grid-template-columns: 1fr;
			text-align: center;
			gap: 8px;
		}
		.summit-title {
			text-align: center;
		}
	}

	.link-arrow {
		font-size: 14px;
		font-weight: 600;
		color: var(--c-link);
		text-decoration: none;
	}
	.link-arrow:hover {
		text-decoration: underline;
	}
</style>
