---
import Layout from "../layouts/Layout.astro";
import HomeAnnouncements from "../components/HomeAnnouncements.astro";
import JournalClubHome from "../components/JournalClubHome.astro";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import SummitDetail from "../components/SummitDetail.astro";

// 1. Determine "Active Summit" (Single Source of Truth)
const allSummits = await getCollection("summits");
const summitInfo = await getEntry("summit", "info");

let activeSummit: CollectionEntry<"summits"> | undefined;

// Strategy 0: Explicit "Featured Summit" from Keystatic
if (summitInfo?.data?.featuredSummit) {
	activeSummit = allSummits.find(
		(s) => s.slug === summitInfo.data.featuredSummit,
	);
}

// Strategy 1: Look for "Live"
if (!activeSummit) {
	activeSummit = allSummits.find((s) => s.data.phase === "Live");
}

// Strategy 2: Look for "Preview"
if (!activeSummit) {
	activeSummit = allSummits.find((s) => s.data.phase === "Preview");
}

// Strategy 3: Look for "Planning"
if (!activeSummit) {
	activeSummit = allSummits.find((s) => s.data.phase === "Planning");
}

// Strategy 4: Fallback to latest by date/year
if (!activeSummit && allSummits.length > 0) {
	activeSummit = allSummits.sort((a, b) => {
		const dateA = a.data.startDate
			? new Date(a.data.startDate).valueOf()
			: 0;
		const dateB = b.data.startDate
			? new Date(b.data.startDate).valueOf()
			: 0;
		if (dateA !== dateB) return dateB - dateA;
		// Fallback to year string comparison
		return (b.data.year || "").localeCompare(a.data.year || "");
	})[0];
}

// Apply Phase Override if present AND not "Auto"
if (
	activeSummit &&
	summitInfo.data.overridePhase &&
	summitInfo.data.overridePhase !== 'Auto'
) {
	activeSummit = {
		...activeSummit,
		data: {
			...activeSummit.data,
			phase: summitInfo.data.overridePhase,
		},
	};
}

const currentPhase = activeSummit?.data.phase || "Planning";
---

<Layout>
	<div data-pagefind-body>
		{
			/* 
            PHASE: PLANNING
            Goal: Enable contact with organizers.
            Content: Hero (Preparation message), CTA (Contact), Link to Past Summits.
        */
		}
		{
			currentPhase === "Planning" && (
				<>
					<section class="hero-planning">
						<div class="container hero-content">
							<h1>We are preparing the next RdRp Summit.</h1>
							<p class="subtitle">
								Details such as date and venue will be announced
								once confirmed.
							</p>
							<div class="cta-wrapper">
								<a href="/contact" class="button primary">
									Contact the organizers
								</a>
							</div>
						</div>
					</section>
					<JournalClubHome variant="standard" showIcon={true} />
				</>
			)
		}

		{
			/* 
            PHASE: PREVIEW
            Goal: Announce upcoming event (save the date).
            Content: "Save the date", Basic facts, Passive CTA.
        */
		}
		{
			currentPhase === "Preview" && !!activeSummit && (
				<>
					<section class="hero-preview">
						<div class="container hero-content">
							<span class="eyebrow">Upcoming Event</span>
							<h1>{activeSummit.data.title}</h1>
							<div class="event-meta">
								{activeSummit.data.startDate && (
									<p class="date">
										Save the Date:{" "}
										{new Date(
											activeSummit.data.startDate,
										).toLocaleDateString()}
									</p>
								)}
								{(activeSummit.data.city ||
									activeSummit.data.country) && (
									<p class="location">
										{[
											activeSummit.data.city,
											activeSummit.data.country,
										]
											.filter(Boolean)
											.join(", ")}
									</p>
								)}
							</div>
							{/* Passive CTA if a detail page exists/is desired, or just omit */}
							<div class="cta-wrapper">
								<span class="info-text">
									More details coming soon.
								</span>
							</div>
						</div>
					</section>
					<JournalClubHome variant="standard" showIcon={true} />
				</>
			)
		}

		{
			/* 
            PHASE: LIVE
            Goal: Drive registration / participation.
            Content: SummitDetail (Full) + Journal Club (Standard).
        */
		}
		{
			currentPhase === "Live" && !!activeSummit && (
				<>
					<SummitDetail item={activeSummit} variant="home" />
					<JournalClubHome variant="standard" showIcon={false} />
				</>
			)
		}

		{
			/* 
            PHASE: ARCHIVED
            Goal: Access to past outcomes.
            Content: Journal Club (Hero) + Past Summit (Detail).
        */
		}
		{
			currentPhase === "Archived" && !!activeSummit && (
				<>
					<JournalClubHome variant="hero" showIcon={true} />

					<section class="past-summits-section">
						<div class="container section-header">
							<h2>Past RdRp Summits</h2>
							<p>
								Explore talks, speakers, and outcomes from
								previous meetings.
							</p>
						</div>
						<SummitDetail item={activeSummit} variant="home" />
					</section>
				</>
			)
		}

		{
			/* 
           COMMON SECTIONS 
           (Announcements & Footer Features are generally safe to show, 
           but strictly for 'Planning', we might want to be minimal. 
           However, 'HomeAnnouncements' might contain relevant news even in Planning.
           Promised "Optional: Small section linking to Past Summits" for Planning.
        */
		}

		{
			/* Show Announcements generally, unless strict minimal mode is requested? User said "Top Page Content (ONLY include...)" for Planning. 
            I will render Announcements but maybe below the fold. 
        */
		}
		<HomeAnnouncements />

		{
			/* For Planning Phase, add specific "Past Summits" link/section if not already covered */
		}
		{
			currentPhase === "Planning" && (
				<section class="planning-history">
					<div class="container">
						<h2>Previous Summits</h2>
						<p>
							Explore the outcomes and archives from our past
							meetings.
						</p>
						<a href="/summits" class="link-arrow">
							View Past Summits &rarr;
						</a>
					</div>
				</section>
			)
		}

		<section class="container features">
			<div class="feature-grid">
				<div class="feature-card">
					<h3>About</h3>
					<p>Discover our mission to map the RNA virosphere.</p>
					<a href="/about" class="link-arrow"> Read more &rarr; </a>
				</div>
				<div class="feature-card">
					<h3>Summits</h3>
					<p>
						Archive of international RdRp summits and proceedings.
					</p>
					<a href="/summits" class="link-arrow">
						Browse archive &rarr;
					</a>
				</div>
				<div class="feature-card">
					<h3>Contact</h3>
					<p>Get in touch with the RdRp Summit team.</p>
					<a href="/contact" class="link-arrow">
						Contact us &rarr;
					</a>
				</div>
			</div>
		</section>
	</div>
</Layout>

<style>
	/* Global Reused */
	.container {
		max-width: 980px;
		margin: 0 auto;
		padding: 0 20px;
	}

	/* Hero Styles for Planning & Preview */
	.hero-planning,
	.hero-preview {
		padding: 100px 0;
		text-align: center;
		background: linear-gradient(
			180deg,
			rgba(230, 246, 255, 0.5) 0%,
			white 100%
		);
	}

	.hero-content h1 {
		font-size: 2.5rem;
		font-weight: 800;
		margin-bottom: 20px;
		color: var(--c-text);
	}

	.subtitle {
		font-size: 1.25rem;
		color: var(--c-text-secondary);
		margin-bottom: 40px;
		max-width: 600px;
		margin-left: auto;
		margin-right: auto;
	}

	.cta-wrapper {
		margin-top: 30px;
	}

	.button.primary {
		background-color: var(--c-primary);
		color: white;
		padding: 12px 24px;
		border-radius: 8px;
		text-decoration: none;
		font-weight: 600;
		transition: opacity 0.2s;
	}
	.button.primary:hover {
		opacity: 0.9;
	}

	/* Preview Specific */
	.eyebrow {
		text-transform: uppercase;
		font-size: 0.9rem;
		letter-spacing: 0.1em;
		color: var(--c-primary);
		font-weight: 700;
		margin-bottom: 10px;
		display: block;
	}
	.event-meta {
		font-size: 1.2rem;
		margin-bottom: 30px;
		color: var(--c-text);
	}
	.info-text {
		color: var(--c-text-secondary);
		font-style: italic;
	}

	/* Past Summits Section Wrapper (Archived) */
	.past-summits-section {
		padding-top: 40px;
	}
	.past-summits-section .section-header {
		text-align: center;
		margin-bottom: 20px;
	}
	.past-summits-section h2 {
		font-size: 2rem;
		margin-bottom: 10px;
	}
	.past-summits-section p {
		color: var(--c-text-secondary);
		font-size: 1.1rem;
	}

	/* Planning History Section */
	.planning-history {
		text-align: center;
		padding: 60px 0;
		border-top: 1px solid rgba(0, 0, 0, 0.05);
	}
	.planning-history h2 {
		font-size: 1.8rem;
		margin-bottom: 0.5em;
	}
	.planning-history p {
		color: var(--c-text-secondary);
		margin-bottom: 1.5em;
	}

	/* Features Grid (Bottom) */
	.features {
		padding-top: 20px;
		padding-bottom: 60px;
	}

	.feature-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
		gap: 30px;
	}

	.feature-card {
		background: white;
		border-radius: 18px;
		padding: 30px;
		box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
		border: 1px solid rgba(0, 0, 0, 0.03);
		transition:
			transform 0.2s ease,
			box-shadow 0.2s ease;
	}

	.feature-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
	}

	.feature-card h3 {
		font-size: 24px;
		margin-bottom: 10px;
	}

	.feature-card p {
		color: var(--c-text-secondary);
		font-size: 15px;
		line-height: 1.5;
		margin-bottom: 16px;
	}

	.link-arrow {
		font-size: 14px;
		font-weight: 600;
		color: var(--c-link);
		text-decoration: none;
	}
	.link-arrow:hover {
		text-decoration: underline;
	}
</style>
