---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export const prerender = true;

export async function getStaticPaths() {
  const items = await getCollection('journal-club');
  return items.map(item => ({
    params: { slug: item.slug },
    props: { item },
  }));
}

const { item } = Astro.props;
const { Content } = await item.render();
const { data } = item;

// Helper to get speaker info (structured for two-line display)
function getSpeakerInfo(): { name: string; affiliation: string | null } | null {
    if (data.speakerName) {
        return {
            name: data.speakerName,
            affiliation: data.speakerAffiliation || null,
        };
    }
    // Fallback to legacy field - try to parse "Name (Affiliation)"
    if (data.speaker) {
        const match = data.speaker.match(/^(.+?)\s*\(([^)]+)\)\s*$/);
        if (match) {
            return { name: match[1].trim(), affiliation: match[2].trim() };
        }
        return { name: data.speaker, affiliation: null };
    }
    return null;
}

// Get all links (new format or legacy)
function getAllLinks(): { label: string; url: string; isPrimary: boolean }[] {
    if (data.links && data.links.length > 0) {
        return data.links;
    }
    if (data.paperUrl) {
        return [{ label: 'Paper', url: data.paperUrl, isPrimary: true }];
    }
    return [];
}

const speakerInfo = getSpeakerInfo();
const allLinks = getAllLinks();

// Helper to get UTC datetime from local or existing UTC field
function getStartDateTimeUtc(): string | null {
    // Prefer existing UTC field for backward compatibility
    if (data.startDateTimeUtc && data.startDateTimeUtc.trim()) {
        return data.startDateTimeUtc.trim();
    }

    // Convert from local date/time if available
    if (data.localDate && data.localTime && data.localTime.trim()) {
        const tz = data.eventTz || 'Asia/Tokyo';
        const dateStr = data.localDate.toISOString().split('T')[0]; // YYYY-MM-DD
        const timeStr = data.localTime.trim(); // HH:mm

        try {
            // Technique: Create a "fake" local date, then adjust for timezone offset
            // Based on: https://stackoverflow.com/a/54127122
            const fakeLocalDate = new Date(`${dateStr}T${timeStr}:00`);

            // Get what this date looks like in the target timezone
            const tzDateString = fakeLocalDate.toLocaleString('en-US', { timeZone: tz });
            const tzDate = new Date(tzDateString);

            // Calculate the difference
            const diff = fakeLocalDate.getTime() - tzDate.getTime();

            // Apply the difference to get the correct UTC time
            const correctUTC = new Date(fakeLocalDate.getTime() + diff);
            return correctUTC.toISOString();
        } catch (e) {
            console.error('Failed to convert local time to UTC:', e);
        }
    }

    return null;
}

const effectiveStartDateTimeUtc = getStartDateTimeUtc();

// Timezone display helper
const TIMEZONES = [
    { name: 'America/Toronto', label: 'Eastern Time (Toronto)' },
    { name: 'America/Santiago', label: 'Chile (Santiago)' },
    { name: 'Europe/Paris', label: 'Central European (Paris)' },
    { name: 'Europe/Vilnius', label: 'Eastern European (Vilnius)' },
    { name: 'Asia/Tokyo', label: 'Japan (Tokyo)' },
    { name: 'Australia/Sydney', label: 'Australian Eastern (Sydney)' },
];

function formatTimeInTimezone(utcIsoString: string, timezone: string): string {
    try {
        const date = new Date(utcIsoString);
        const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: timezone,
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
        });
        return formatter.format(date);
    } catch (e) {
        return 'Invalid date';
    }
}

// Format date for header
function formatHeaderDate(date: Date): string {
    const formatter = new Intl.DateTimeFormat('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
    });
    return formatter.format(date);
}

// Check if event has ended (for auto-hiding Zoom link)
const hasEventEnded = effectiveStartDateTimeUtc
    ? new Date().getTime() > new Date(effectiveStartDateTimeUtc).getTime() + 2 * 60 * 60 * 1000 // Event end = start + 2 hours
    : false;
---

<Layout title={item.data.title}>
	<div class="container page-content">
		<div class="back-link">
			<a href="/journal-club">‚Üê Back to Journal Club</a>
		</div>

        {/* A. Header: Date, Title, Speaker */}
        <header class="post-header">
            <div class="meta">
                <time>{formatHeaderDate(item.data.date)}</time>
            </div>
            <h1 class="page-title">{item.data.title}</h1>

            {speakerInfo && (
                <div class="speaker-section">
                    <span class="speaker-name">{speakerInfo.name}</span>
                    {speakerInfo.affiliation && (
                        <span class="speaker-affiliation">{speakerInfo.affiliation}</span>
                    )}
                </div>
            )}
        </header>

        {/* B. Actions: Code links, Add to Calendar, Zoom (consolidated) */}
        <div class="actions-section">
            {allLinks.map(link => (
                <a
                    href={link.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="action-link"
                >
                    {link.label} &nearr;
                </a>
            ))}
            {data.calendarUrl && (
                <a
                    href={data.calendarUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="action-button calendar-button"
                >
                    Add to Calendar
                </a>
            )}
            {data.zoomUrl && data.showZoomLink && !hasEventEnded && (
                <a
                    href={data.zoomUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="action-button zoom-button"
                >
                    Join Zoom
                </a>
            )}
            {data.zoomUrl && !data.showZoomLink && !hasEventEnded && (
                <span class="zoom-note">Zoom link available via Slack</span>
            )}
        </div>

        {/* C. Main Content */}
		<div class="content-wrapper">
			<article>
				<Content />
			</article>
		</div>

        {/* D. Event Times (reference section - bottom) */}
        {effectiveStartDateTimeUtc && (
            <aside class="event-times-section">
                <h3 class="event-times-heading">Event Times</h3>
                <ul class="timezone-list">
                    {TIMEZONES.map(tz => (
                        <li class="timezone-item">
                            <span class="timezone-label">{tz.label}:</span>
                            <span class="timezone-time">{formatTimeInTimezone(effectiveStartDateTimeUtc, tz.name)}</span>
                        </li>
                    ))}
                </ul>
            </aside>
        )}
	</div>
</Layout>

<style>
	.page-content {
		max-width: 720px;
		margin: 0 auto;
	}

	.page-title {
		margin-top: 10px;
		margin-bottom: 20px;
        text-align: center;
	}
    
    .post-header {
        margin-top: 40px;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e5e7eb;
    }

    .meta {
        color: var(--c-text-light, #666);
        margin-bottom: 10px;
        text-align: center;
        font-size: 0.95em;
    }

    .speaker-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        margin-top: 20px;
    }

    .speaker-name {
        font-size: 1.1em;
        font-weight: 600;
        color: var(--c-text, #333);
    }

    .speaker-affiliation {
        font-size: 0.95em;
        color: var(--c-text-secondary, #666);
    }

    /* Actions Section (consolidated) */
    .actions-section {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 48px;
        padding: 20px;
        background-color: #f9fafb;
        border-radius: 8px;
        flex-wrap: wrap;
        align-items: center;
    }

    .action-link {
        display: inline-block;
        padding: 8px 16px;
        border: 1px solid var(--c-link, #0070f3);
        border-radius: 6px;
        color: var(--c-link, #0070f3);
        text-decoration: none;
        font-size: 0.9em;
        transition: background-color 0.2s, color 0.2s;
    }

    .action-link:hover {
        background-color: var(--c-link, #0070f3);
        color: white;
        text-decoration: none;
    }

    .action-button {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9em;
        transition: opacity 0.2s;
    }

    .action-button:hover {
        opacity: 0.8;
        text-decoration: none;
    }

    .calendar-button {
        background-color: #4285f4;
        color: white;
    }

    .zoom-button {
        background-color: #2d8cff;
        color: white;
    }

    .zoom-note {
        font-size: 0.9em;
        color: var(--c-text-secondary, #666);
        font-style: italic;
    }

	.content-wrapper {
		font-size: 18px;
		line-height: 1.6;
		color: var(--c-text, #333);
        margin-bottom: 60px;
	}

    /* Event Times Section (bottom reference) */
    .event-times-section {
        margin-top: 48px;
        padding: 24px;
        background-color: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .event-times-heading {
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 16px;
        margin-top: 0;
        color: var(--c-text-secondary, #666);
    }

    .timezone-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .timezone-item {
        font-size: 0.9em;
        color: var(--c-text, #333);
        padding: 10px 0;
        line-height: 1.6;
        border-bottom: 1px solid #f0f0f0;
    }

    .timezone-item:last-child {
        border-bottom: none;
    }

    .timezone-label {
        font-weight: 500;
        color: var(--c-text-secondary, #666);
        display: inline-block;
        min-width: 200px;
    }

    .timezone-time {
        color: var(--c-text, #333);
        font-variant-numeric: tabular-nums;
    }

	.back-link {
		margin-top: 40px;
	}

	.back-link a {
		color: var(--c-text-light, #666);
		text-decoration: none;
		font-size: 0.9em;
	}

	.back-link a:hover {
		text-decoration: underline;
	}

  /* Basic styling for content */
  article :global(h2) {
    margin-top: 2em;
    font-size: 1.5em;
    font-weight: 600;
  }

  article :global(h3) {
      margin-top: 1.5em;
      font-size: 1.25em;
      font-weight: 600;
  }

  article :global(p) {
    margin-bottom: 1em;
  }

  article :global(ul), article :global(ol) {
    margin-bottom: 1em;
    padding-left: 2em;
  }

  /* Note: Legacy entries may have duplicate sections in body content */
  /* Ideally, these should be cleaned up when editing old entries */
  /* The template prioritizes structured frontmatter data over body content */
</style>
