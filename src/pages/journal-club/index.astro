---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export const prerender = true;

const items = await getCollection("journal-club");
const sortedItems = items.sort(
    (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf(),
);

// Helper to get speaker display string
function getSpeakerDisplay(data: typeof sortedItems[0]['data']): string {
    // New structured fields
    if (data.speakerName) {
        return data.speakerAffiliation
            ? `${data.speakerName} (${data.speakerAffiliation})`
            : data.speakerName;
    }
    // Fallback to legacy field
    return data.speaker || '-';
}

// Helper to get primary link
function getPrimaryLink(data: typeof sortedItems[0]['data']): { label: string; url: string } | null {
    // New links array
    if (data.links && data.links.length > 0) {
        const primary = data.links.find(l => l.isPrimary) || data.links[0];
        return { label: primary.label, url: primary.url };
    }
    // Fallback to legacy field
    if (data.paperUrl) {
        return { label: 'Link', url: data.paperUrl };
    }
    return null;
}
---

<Layout>
    <div class="container page-content">
        <h1 class="page-title">RNA Virus Journal Club</h1>

        <div class="intro-section">
            <p class="intro-text">
                The <strong>RNA Virus Journal Club</strong> is a community project
                emerging from the <a href="/">RdRp Summit</a>. Driven by the
                community, it provides a platform to discuss recent papers,
                methods, and ideas related to RNA virus biology, RdRp discovery,
                and computational virology.
            </p>
            <p class="intro-text">
                Announcements and discussions take place on our <strong
                    >Slack</strong
                > channel, and session times are coordinated via our <strong
                    >Google Calendar</strong
                >.
            </p>

            <div class="action-container">
                <a
                    href="https://docs.google.com/forms/d/e/1FAIpQLSdjvzJGh4vtCcq76qP79CW2qniycLix_LMwIfVRdG2bbuuPNg/viewform?usp=dialog"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="nomination-button"
                >
                    Nominate a Speaker / Chair
                </a>
                <p class="action-note">
                    Community members are encouraged to nominate themselves or
                    others.
                </p>
            </div>
        </div>

        <div class="journal-list">
            <div class="table-container">
                <table class="journal-table">
                    <thead>
                        <tr>
                            <th class="col-date">Date</th>
                            <th class="col-topic">Paper / Topic</th>
                            <th class="col-speaker">Speaker</th>
                            <th class="col-link">Paper</th>
                        </tr>
                    </thead>
                    <tbody>
                        {
                            sortedItems.map((item) => {
                                const primaryLink = getPrimaryLink(item.data);
                                return (
                                    <tr>
                                        <td class="col-date">
                                            {item.data.date.toLocaleDateString()}
                                        </td>
                                        <td class="col-topic">
                                            <a
                                                href={`/journal-club/${item.slug}`}
                                                class="topic-link"
                                            >
                                                {item.data.title}
                                            </a>
                                        </td>
                                        <td class="col-speaker">
                                            {getSpeakerDisplay(item.data)}
                                        </td>
                                        <td class="col-link">
                                            {primaryLink ? (
                                                <a
                                                    href={primaryLink.url}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    class="paper-link"
                                                >
                                                    {primaryLink.label} &nearr;
                                                </a>
                                            ) : (
                                                "-"
                                            )}
                                        </td>
                                    </tr>
                                );
                            })
                        }
                    </tbody>
                </table>
            </div>

            <div class="journal-list-mobile">
                {
                    sortedItems.map((item) => {
                        const speakerDisplay = getSpeakerDisplay(item.data);
                        const primaryLink = getPrimaryLink(item.data);
                        return (
                            <div class="journal-item">
                                <div class="item-date">
                                    {item.data.date.toLocaleDateString()}
                                </div>
                                <h3 class="item-title">
                                    <a href={`/journal-club/${item.slug}`}>
                                        {item.data.title}
                                    </a>
                                </h3>
                                {speakerDisplay !== '-' && (
                                    <div class="item-speaker">
                                        Speaker: {speakerDisplay}
                                    </div>
                                )}
                                {primaryLink && (
                                    <a
                                        href={primaryLink.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="item-paper-link"
                                    >
                                        {primaryLink.label} &nearr;
                                    </a>
                                )}
                            </div>
                        );
                    })
                }
            </div>
        </div>
    </div>
</Layout>

<style>
    .page-content {
        max-width: 980px;
        margin: 0 auto;
    }

    .page-title {
        margin-top: 40px;
        margin-bottom: 20px;
        text-align: center;
    }

    .intro-section {
        max-width: 700px;
        margin: 0 auto 50px;
        text-align: center;
    }

    .intro-text {
        font-size: 1.1em;
        line-height: 1.5;
        color: var(--c-text);
        margin-bottom: 1em;
    }

    .action-container {
        margin-top: 30px;
    }

    .nomination-button {
        display: inline-block;
        padding: 10px 24px;
        background-color: var(--c-link);
        color: white;
        text-decoration: none;
        border-radius: 999px;
        font-weight: 500;
        transition: opacity 0.2s;
    }

    .nomination-button:hover {
        opacity: 0.8;
        text-decoration: none;
        color: white;
    }

    .action-note {
        margin-top: 12px;
        font-size: 0.9em;
        color: var(--c-text-secondary);
    }

    /* Table Styles (Desktop) */
    .table-container {
        display: none;
    }

    @media (min-width: 768px) {
        .table-container {
            display: block;
        }
        .journal-list-mobile {
            display: none;
        }
    }

    .journal-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 16px;
    }

    .journal-table th,
    .journal-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--c-divider, #eee);
    }

    .journal-table th {
        font-weight: 600;
        color: var(--c-text-secondary, #666);
        border-bottom: 2px solid var(--c-divider, #eee);
    }

    .col-date {
        white-space: nowrap;
        width: 120px;
    }
    .col-speaker {
        width: 150px;
    }
    .col-link {
        width: 100px;
        text-align: right !important;
    }

    .topic-link {
        font-weight: 500;
        color: var(--c-text, #333);
        text-decoration: none;
    }

    .topic-link:hover {
        color: var(--c-link, #0070f3);
        text-decoration: underline;
    }

    .paper-link {
        color: var(--c-link, #0070f3);
        text-decoration: none;
        font-size: 0.9em;
    }

    .paper-link:hover {
        text-decoration: underline;
    }

    /* Mobile List Styles */
    .journal-item {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--c-divider, #eee);
    }

    .item-date {
        font-size: 0.9em;
        color: var(--c-text-secondary, #666);
        margin-bottom: 4px;
    }

    .item-title {
        margin: 0 0 8px;
        font-size: 1.1em;
    }

    .item-title a {
        color: var(--c-text, #333);
        text-decoration: none;
    }

    .item-speaker {
        font-size: 0.95em;
        margin-bottom: 8px;
    }

    .item-paper-link {
        color: var(--c-link, #0070f3);
        text-decoration: none;
        font-size: 0.9em;
    }
</style>
